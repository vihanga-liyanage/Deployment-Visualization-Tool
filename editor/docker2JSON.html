<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Docker 2 JSON</title>

    <!--Jquery all-->
    <link rel="stylesheet" href="css/jquery-ui.min.css">
    <script src="js/jquery-1.12.4.min.js"></script>
    <script src="js/jquery-ui.min.js"></script>

    <script src="js/yaml.js"></script>

    <script type="text/javascript">

        var baseDir = 'http://localhost/Deployment-Visualization-Tool/editor/resources/';
        var composeFile = baseDir + 'pattern-3/docker-compose.yml';
        var modelStr = '{"services":[';
        var model = JSON.parse(
            '{"services":[' +
                '{' +
                    '"id":1,' +
                    '"type":"database",' +
                    '"name":"apim_rdbms",' +
                    '"image":"mysql:5.5",' +
                    '"ports":[],' +
                    '"links":[' +
                        '{' +
                        '"serviceId":2' +
                        '},' +
                        '{' +
                        '"serviceId":3' +
                        '}' +
                    '],' +
                    '"profile":""' +
                '}' +
            ']}'
        );

        var loadDockerConfig = function(ymlFile)
        {
            YAML.fromURL(ymlFile, function(data)
            {
                var errors = YAML.getErrors();
                if (errors.length == 0)
                {
                    document.getElementById("out").innerHTML = "Done! Took " + YAML.getProcessingTime() +
                        " miliseconds.<br><br>";
                    // Process each service in yml file
                    var serviceID = 1;
                    for (var key in data.services)
                    {
                        processService(serviceID, key, data.services[key]);
                        serviceID ++;
                    }

                    modelStr = modelStr.slice(0, -1) + ']}';
                    var model = JSON.parse(modelStr);
                } else
                {
                    console.error(errors.join("<br>"));
                }
            });
        };

        var processService = function (serviceID, key, service)
        {
            document.getElementById("out").innerHTML += key + "=============================<br>";
            modelStr += '{"id":' + serviceID + ',';

            //Extracting type and name from key
            var i = key.indexOf('-');
            var type = key.substring(0, i);
            var name = key.substring(i + 1);
            modelStr += '"type":"' + type + '",';
            modelStr += '"name":"' + name + '",';

            //set image
            modelStr += '"image":"' + service.image + '",';

            modelStr += '"ports":[],' +
                '"links":[],' +
                '"profile":""' +
                '},';

            if (service.build != null)
            {
                var dockerfile = baseDir + service.build.dockerfile;
                document.getElementById("out").innerHTML += dockerfile + "<br>";
                var dockerFileContent = readTextFile(dockerfile);
                document.getElementById("out").innerHTML += dockerFileContent + "<br>";
            }
        };

        loadDockerConfig(composeFile);

        function readTextFile(file)
        {
            var allText = "Error";
            var rawFile = new XMLHttpRequest();
            rawFile.open("GET", file, false);
            rawFile.onreadystatechange = function ()
            {
                if(rawFile.readyState === 4)
                {
                    if(rawFile.status === 200 || rawFile.status == 0)
                    {
                        allText = rawFile.responseText;
                    }
                }
            };
            rawFile.send(null);
            return allText;
        }

//        readFile(dir);

    </script>
</head>
<body>
    <pre id="out"></pre>
</body>
</html>